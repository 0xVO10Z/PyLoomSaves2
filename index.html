<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyLoom - Python Compiler, Interpreter & IDE</title>
    <link rel="icon" type="image/x-icon" href="/images/PyloomIcon_Round.png">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=JetBrains+Mono:wght@400;600&family=Source+Code+Pro:wght@400;600&family=Ubuntu+Mono:wght@400;700&family=Inconsolata:wght@400;600&family=Share+Tech+Mono&family=VT323&family=Overpass+Mono:wght@400;600&family=Press+Start+2P&family=Courier+Prime:wght@400;700&family=Space+Mono:wght@400;700&family=Anonymous+Pro&family=Roboto+Mono:wght@400;700&family=PT+Mono&family=M+PLUS+1+Code&family=Major+Mono+Display&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Roboto+Mono:wght@400;700&family=Anonymous+Pro:wght@400;700&family=Cousine:wght@400;700&family=Nova+Mono&display=swap" rel="stylesheet">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/ambiance.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/blackboard.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/base16-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/base16-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/mdn-like.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/material.min.css">
    <!-- Removed Font Awesome CSS -->
    <style>
        :root {
            --primary-color: #6272a4;
            --success-color: #50fa7b;
            --error-color: #ff5555;
            --warning-color: #ffb86c;
            --info-color: #8be9fd;
        }

        * {
            font-family: inherit !important;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            padding: 12px 20px;
            text-align: center;
            font-family: 'Fira Code', monospace;
            font-size: 1.5rem;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #header-controls {
            display: flex;
            gap: 10px;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 20px;
            justify-content: center;
            align-items: center;
        }

        #filename,
        select {
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            font-family: 'Fira Code', monospace;
            font-size: 0.95rem;
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.4);
            outline: none;
            transition: all 0.2s ease;
        }

        #filename:focus,
        select:focus {
            transform: scale(1.02);
        }

        button,
        label.choose-file {
            padding: 10px 18px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--primary-color);
            color: #e0e0e0;
        }

        button:hover,
        label.choose-file:hover,
        select:hover {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-success {
            background-color: var(--success-color);
            color: #000;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #000;
        }

        .btn-error {
            background-color: var(--error-color);
        }

        .btn-info {
            background-color: var(--info-color);
            color: #000;
        }

        input[type="file"] {
            display: none;
        }

        #editor-output-container {
            display: flex;
            flex-direction: row;
            flex: 1;
            padding: 10px 20px;
            gap: 10px;
            overflow: hidden;
            height: calc(100vh - 180px);
        }

        #editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #editor-header {
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        #editor-actions {
            display: flex;
            gap: 10px;
        }

        .editor-action {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .editor-action:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .CodeMirror {
            flex: 1;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            font-size: 14px;
        }

        #output-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #output-header {
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        #output-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .output-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            color: inherit;
            font-family: inherit;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .output-tab.active {
            border-bottom: 2px solid var(--primary-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .output-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .output-panel {
            display: none;
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
            flex-direction: column;
            position: relative;
        }

        .output-panel.active {
            display: flex;
        }

        #output-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
        }

        #compiler-output {
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
        }

        #ast-visualization {
            font-family: 'Fira Code', monospace;
        }

        .ast-node {
            margin-left: 20px;
            padding: 5px;
            border-left: 2px solid var(--primary-color);
        }

        .ast-keyword {
            color: var(--info-color);
            font-weight: bold;
        }

        .ast-identifier {
            color: var(--success-color);
        }

        .ast-literal {
            color: var(--warning-color);
        }

        #input-container {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            bottom: 0;
            backdrop-filter: blur(5px);
        }

        #input-prompt {
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: inherit;
        }

        #user-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.25);
            color: inherit;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        #user-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        #submit-input {
            margin-top: 8px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--primary-color);
            border: none;
            border-radius: 4px;
            color: white;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
        }

        #submit-input:hover {
            background-color: #7284b8;
            transform: translateY(-1px);
        }

        #submit-input:active {
            transform: translateY(0);
        }

        #popup-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
            align-items: flex-end;
        }

        .popup {
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            color: #fff;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            pointer-events: none;
            min-width: 200px;
            text-align: center;
        }

        .popup.show {
            opacity: 1;
            transform: translateY(0);
        }

        #info-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #info-popup-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        #info-popup {
            width: 80%;
            max-width: 700px;
            height: 70%;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            animation: popupOpen 0.3s ease forwards;
        }

        #info-popup h2 {
            margin: 0;
            text-align: center;
        }

        #info-popup textarea {
            flex: 1;
            resize: none;
            overflow-y: auto;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: inherit;
            font-size: 0.95rem;
            user-select: none;
        }

        #info-popup button {
            align-self: center;
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        #share-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #share-popup-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        #share-popup {
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: popupOpen 0.3s ease forwards;
        }

        #share-popup h2 {
            margin: 0;
            text-align: center;
        }

        #share-popup input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            font-family: inherit;
            font-size: 0.95rem;
        }

        #share-popup button {
            align-self: center;
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        #share-popup .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #settings-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #settings-popup-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        #settings-popup {
            width: 80%;
            max-width: 600px;
            height: 70%;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: popupOpen 0.3s ease forwards;
        }

        #settings-popup h2 {
            margin: 0;
            text-align: center;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .setting-control {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            font-family: inherit;
        }

        .setting-checkbox {
            margin-right: 8px;
        }

        #settings-popup button {
            align-self: center;
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        @keyframes popupOpen {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes popupClose {
            from {
                transform: scale(1);
                opacity: 1;
            }

            to {
                transform: scale(0.9);
                opacity: 0;
            }
        }

        footer {
            padding: 10px 20px;
            text-align: center;
            font-size: 0.85rem;
            border-top: 1px solid;
            opacity: 0.75;
            transition: color 0.3s ease, opacity 0.3s ease, border-color 0.3s ease;
        }

        footer:hover {
            opacity: 1;
        }

        header,
        button,
        label.choose-file,
        select,
        .popup,
        footer {
            user-select: none;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 5px 15px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .execution-mode {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .mode-indicator {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .mode-interpreter {
            background-color: var(--info-color);
            color: #000;
        }

        .mode-compiler {
            background-color: var(--warning-color);
            color: #000;
        }

        @media (max-width: 800px) {
            #editor-output-container {
                flex-direction: column;
            }

            #controls {
                flex-direction: column;
                align-items: stretch;
            }

            #share-popup {
                width: 90%;
                max-width: 90%;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }
        }

        textarea,
        pre,
        code,
        .editor,
        .cm-content,
        .cm-line {
            font-family: 'Fira Code', 'JetBrains Mono', monospace !important;
            font-variant-ligatures: none;
            letter-spacing: 0;
        }

        .cm-matchhighlight {
            background-color: rgba(255, 255, 0, 0.3);
        }

        .CodeMirror-foldmarker {
            color: #88f;
            text-shadow: #88f 0 0 2px, #88f 0 0 2px, #88f 0 0 2px;
            font-family: sans-serif;
            line-height: .3;
            cursor: pointer;
        }

        .CodeMirror-foldgutter {
            width: 1.2em;
        }

        .CodeMirror-foldgutter-open,
        .CodeMirror-foldgutter-folded {
            cursor: pointer;
        }

        .CodeMirror-foldgutter-open:after {
            content: "\25BE";
        }

        .CodeMirror-foldgutter-folded:after {
            content: "\25B8";
        }

        .compiler-line {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .compiler-error {
            background-color: rgba(255, 85, 85, 0.1);
            border-left: 3px solid var(--error-color);
        }

        .compiler-warning {
            background-color: rgba(255, 184, 108, 0.1);
            border-left: 3px solid var(--warning-color);
        }

        .compiler-info {
            background-color: rgba(139, 233, 253, 0.1);
            border-left: 3px solid var(--info-color);
        }

        .bytecode-line {
            font-family: 'Fira Code', monospace;
            margin: 2px 0;
            padding-left: 10px;
        }

        .bytecode-op {
            color: var(--info-color);
            font-weight: bold;
        }

        .bytecode-arg {
            color: var(--success-color);
        }

        .bytecode-comment {
            color: #888;
            font-style: italic;
        }

        /* Ensure CodeMirror respects the theme font */
        .CodeMirror {
            font-family: inherit !important;
        }

        .CodeMirror-code {
            font-family: inherit !important;
        }

        .cm-line {
            font-family: inherit !important;
        }

        /* Ensure all UI elements inherit the theme font */
        body, div, span, p, pre, code, textarea, input, select, button, label,
        header, footer, h1, h2, h3, h4, h5, h6, a, li, ul, ol, td, th, table {
            font-family: inherit !important;
        }
    </style>
</head>
<body id="body">
    <header>
        <p><strong>PyLoom</strong> - Python Compiler, Interpreter & IDE</p>
        <div id="header-controls">
            <button onclick="openSettingsPopup()">⚙️ Settings</button>
            <button onclick="toggleFullscreen()">⛶ Fullscreen</button>
        </div>
    </header>
    <div id="controls">
        <div class="execution-mode">
            <span>Mode:</span>
            <span class="mode-indicator mode-interpreter" id="mode-indicator">INTERPRETER</span>
        </div>
        <button onclick="runCode()" class="btn-success">▶️ Run</button>
        <button onclick="compileCode()" class="btn-info">⚙️ Compile</button>
        <button onclick="debugCode()" class="btn-warning">🐛 Debug</button>
        <button onclick="clearEditor()" class="btn-error">🗑️ Clear</button>
        <input type="text" id="filename" placeholder="Enter filename (e.g., script.py)">
        <button onclick="saveFile()">💾 Save</button>
        <label class="choose-file">📁 Choose File<input type="file" id="uploadFile" onchange="uploadFile(event)"></label>
        <select id="themeSelect" onchange="changeTheme(this.value)">
            <option value="ambiance">Ambiance</option>
            <option value="base16-dark">Base16 Dark</option>
            <option value="base16-light">Base16 Light</option>
            <option value="blackboard">Blackboard</option>
            <option value="byte">Byte</option>
            <option value="carbon">Carbon</option>
            <option value="classic">Classic</option>
            <option value="cyberpunk">Cyberpunk</option>
            <option value="dracula">Dracula</option>
            <option value="eclipse">Eclipse</option>
            <option value="ether">Ether</option>
            <option value="gruvbox">Gruvbox</option>
            <option value="hacker">Hacker</option>
            <option value="material">Material</option>
            <option value="matrix">Matrix</option>
            <option value="mdn-like">MDN Like</option>
            <option value="midnight">Midnight</option>
            <option value="monokai">Monokai</option>
            <option value="nebula">Nebula</option>
            <option value="nord">Nord</option>
            <option value="paper">Paper</option>
            <option value="polaris">Polaris</option>
            <option value="solarized">Solarized</option>
            <option value="tokyo-night">Tokyo Night</option>
            <option value="vintage">Vintage</option>
            <option value="zenburn">Zenburn</option>
        </select>
        <button onclick="openSharePopup()">🔗 Share</button>
        <button onclick="openInfoPopup()">ℹ️ Info</button>
    </div>
    <div id="editor-output-container">
        <div id="editor-container">
            <div id="editor-header">
                <span>Python Editor</span>
                <div id="editor-actions">
                    <button class="editor-action" title="Find and Replace" onclick="openFindReplace()">🔍</button>
                    <button class="editor-action" title="Toggle Comment" onclick="toggleComment()">💬</button>
                    <button class="editor-action" title="Format Code" onclick="formatCode()">📐</button>
                    <button class="editor-action" title="Increase Font Size" onclick="changeFontSize(1)">🔍+</button>
                    <button class="editor-action" title="Decrease Font Size" onclick="changeFontSize(-1)">🔍-</button>
                </div>
            </div>
            <textarea id="editor"># PyLoom - Python Compiler & Interpreter
# Write your Python code here and run it in interpreter or compiler mode

def fibonacci(n):
    """Calculate the nth Fibonacci number"""
    if n <= 1:
        return n
    else:
        return fibonacci(n-1) + fibonacci(n-2)

def factorial(n):
    """Calculate factorial of n"""
    result = 1
    for i in range(1, n + 1):
        result *= i
    return result

# Main program
if __name__ == "__main__":
    print("=== PyLoom Python Execution ===")
    print(f"Fibonacci(10) = {fibonacci(10)}")
    print(f"Factorial(5) = {factorial(5)}")
    
    # List comprehension example
    squares = [x**2 for x in range(1, 6)]
    print(f"Squares: {squares}")
    
    # Dictionary example
    student = {"name": "Alice", "age": 20, "grade": "A"}
    print(f"Student: {student}")</textarea>
            <div class="status-bar">
                <div class="status-item">
                    <span>🐍</span>
                    <span id="language-status">Python</span>
                </div>
                <div class="status-item">
                    <span>📏</span>
                    <span id="cursor-position">Line 1, Column 1</span>
                </div>
            </div>
        </div>
        <div id="output-container">
            <div id="output-header">
                <span>Output & Analysis</span>
                <div id="output-actions">
                    <button class="editor-action" title="Clear Output" onclick="clearOutput()">🗑️</button>
                    <button class="editor-action" title="Copy Output" onclick="copyOutput()">📋</button>
                </div>
            </div>
            <div id="output-tabs">
                <button class="output-tab active" onclick="switchOutputTab('output')">Output</button>
                <button class="output-tab" onclick="switchOutputTab('compiler')">Compiler</button>
                <button class="output-tab" onclick="switchOutputTab('ast')">AST</button>
                <button class="output-tab" onclick="switchOutputTab('bytecode')">Bytecode</button>
            </div>
            <div id="output-panel" class="output-panel active">
                <div id="output-content">Output will appear here...</div>
                <div id="input-container">
                    <div id="input-prompt"></div>
                    <input type="text" id="user-input" placeholder="Type your response here...">
                    <button id="submit-input">Submit</button>
                </div>
            </div>
            <div id="compiler-panel" class="output-panel">
                <div id="compiler-output">Compiler output will appear here...</div>
            </div>
            <div id="ast-panel" class="output-panel">
                <div id="ast-visualization">Abstract Syntax Tree visualization will appear here...</div>
            </div>
            <div id="bytecode-panel" class="output-panel">
                <div id="bytecode-output">Python bytecode will appear here...</div>
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <span>💻</span>
                    <span id="execution-status">Ready</span>
                </div>
                <div class="status-item">
                    <span>⏱️</span>
                    <span id="execution-time">0.00s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Popup -->
    <div id="info-popup-overlay">
        <div id="info-popup">
            <h2>PyLoom Features & Updates</h2>
            <div id="info-text" style="flex:1; overflow-y:auto; padding:10px; border-radius:6px; background-color: rgba(0,0,0,0.1); color: inherit; font-family: inherit; white-space: pre-wrap;">
<strong>v1 🚀 [19.09.25]: </strong> - 🐍 Python code execution in-browser - Responsive design

<strong>v2 🚀 [20.09.25]:</strong> - 🎨 Multiple themes: Dracula, Monokai, Eclipse, etc. - Save and upload .py files - Auto-save to localStorage - Smooth popups and theme transitions

<strong>v3 🛠️ [21.09.25]:</strong> - 💡 New themes (Matrix, Nord, Cyberpunk, Vintage, Midnight)

<strong>v4 🛠️ [22.09.25]:</strong> - 💡 5 additional custom themes: Nebula, Ether, Polaris, Byte, Classic

<strong>v5 🛠️ [22.09.25]:</strong> - 💡 5 additional custom themes: Carbon, Paper, Zenburn, Gruvbox, Tokyo Night

<strong>v6 🚀 [23.09.25]:</strong> - 🔁 Share code via temporary links (expire after 24 hours)

<strong>v7 🚀 [Latest]:</strong> - ⌨️ Interactive input system - No more browser popups for input()

<strong>v8 🚀 [NEW]:</strong> - 🔧 Professional IDE features: Debug mode, Code formatting, Find & Replace, Auto-completion, Error highlighting, Code folding, Multiple cursors, Fullscreen mode, Settings panel

<strong>v9 🚀 [NEW]:</strong> - 📦 Built-in module support (math, random, datetime)

<strong>v10 🚀 [NEW]:</strong> - ⚡ Complete Compiler & Interpreter: 
    • Python bytecode compilation
    • Abstract Syntax Tree visualization
    • Compiler warnings and errors
    • Execution mode switching
    • Advanced code analysis
            </div>
            <button onclick="closeInfoPopup()">Close</button>
        </div>
    </div>

    <!-- Share Popup -->
    <div id="share-popup-overlay">
        <div id="share-popup">
            <h2>Share Your Code</h2>
            <p>Generate a temporary link to share your code. The link will expire after 24 hours.</p>
            <input type="text" id="share-link" readonly placeholder="Share link will appear here...">
            <div class="share-buttons">
                <button onclick="generateShareLink()">Generate Link</button>
                <button onclick="copyShareLink()">Copy Link</button>
                <button onclick="closeSharePopup()">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Popup -->
    <div id="settings-popup-overlay">
        <div id="settings-popup">
            <h2>IDE Settings</h2>
            <div class="setting-group">
                <label class="setting-label">Execution Mode</label>
                <select id="execution-mode" class="setting-control" onchange="changeExecutionMode(this.value)">
                    <option value="interpreter">Interpreter</option>
                    <option value="compiler">Compiler</option>
                </select>
            </div>
            <div class="setting-group">
                <label class="setting-label">Editor Font Size</label>
                <input type="range" id="font-size" class="setting-control" min="12" max="24" value="14" onchange="updateFontSize(this.value)">
                <span id="font-size-value">14px</span>
            </div>
            <div class="setting-group">
                <label class="setting-label">Tab Size</label>
                <select id="tab-size" class="setting-control" onchange="updateTabSize(this.value)">
                    <option value="2">2 spaces</option>
                    <option value="4" selected>4 spaces</option>
                    <option value="8">8 spaces</option>
                </select>
            </div>
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="line-numbers" class="setting-checkbox" checked onchange="toggleLineNumbers(this.checked)">
                    Show Line Numbers
                </label>
            </div>
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="auto-close-brackets" class="setting-checkbox" checked onchange="toggleAutoCloseBrackets(this.checked)">
                    Auto-close Brackets
                </label>
            </div>
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="match-brackets" class="setting-checkbox" checked onchange="toggleMatchBrackets(this.checked)">
                    Highlight Matching Brackets
                </label>
            </div>
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="auto-indent" class="setting-checkbox" checked onchange="toggleAutoIndent(this.checked)">
                    Auto-indent
                </label>
            </div>
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="code-folding" class="setting-checkbox" checked onchange="toggleCodeFolding(this.checked)">
                    Enable Code Folding
                </label>
            </div>
            <div class="setting-group">
                <label class="setting-label">
                    <input type="checkbox" id="auto-save" class="setting-checkbox" checked onchange="toggleAutoSave(this.checked)">
                    Auto-save Code
                </label>
            </div>
            <button onclick="closeSettingsPopup()">Close</button>
        </div>
    </div>

    <!-- Find & Replace Popup -->
    <div id="find-replace-popup" style="display: none; position: absolute; top: 40px; right: 20px; background: #2d2d30; padding: 10px; border-radius: 5px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <input type="text" id="find-input" placeholder="Find" style="flex: 1; padding: 5px; border-radius: 3px; border: 1px solid #555;">
            <button onclick="findNext()" style="padding: 5px 10px; background: var(--primary-color); border: none; border-radius: 3px; color: white; cursor: pointer;">Find</button>
        </div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="replace-input" placeholder="Replace with" style="flex: 1; padding: 5px; border-radius: 3px; border: 1px solid #555;">
            <button onclick="replaceNext()" style="padding: 5px 10px; background: var(--primary-color); border: none; border-radius: 3px; color: white; cursor: pointer;">Replace</button>
            <button onclick="replaceAll()" style="padding: 5px 10px; background: var(--primary-color); border: none; border-radius: 3px; color: white; cursor: pointer;">All</button>
            <button onclick="closeFindReplace()" style="padding: 5px 10px; background: #555; border: none; border-radius: 3px; color: white; cursor: pointer;">X</button>
        </div>
    </div>

    <div id="popup-container"></div>
    <footer id="footer">© <span id="year"></span> <strong>PyLoom</strong> by <strong>@atif.a6z v10</strong></footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/search/searchcursor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>
    <script>
        // Enhanced PyLoom with Compiler & Interpreter capabilities

        // Database simulation using localStorage
        const shareDB = {
    generateId: function() {
        return 'pyloom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    },
    
    saveCode: function(code, theme) {
        const id = this.generateId();
        // Set expiration to exactly 24 hours from now
        const expiration = Date.now() + (24 * 60 * 60 * 1000); // 24 hours in milliseconds
        
        const shareData = {
            code: code,
            theme: theme,
            expiration: expiration
        };
        
        // Store in localStorage with a unique key
        try {
            localStorage.setItem('pyloom_share_' + id, JSON.stringify(shareData));
            // Verify storage
            if (localStorage.getItem('pyloom_share_' + id)) {
                return id;
            } else {
                throw new Error("Failed to store share data");
            }
        } catch (e) {
            console.error("Error saving share data:", e);
            return null;
        }
    },
    
    getCode: function(id) {
        try {
            const key = 'pyloom_share_' + id;
            const data = localStorage.getItem(key);
            
            if (!data) {
                console.warn("No data found for share ID:", id);
                return null;
            }
            
            const shareData = JSON.parse(data);
            
            // Verify expiration
            if (!shareData.expiration || Date.now() > shareData.expiration) {
                console.warn("Share link expired or invalid for ID:", id);
                localStorage.removeItem(key);
                return null;
            }
            
            return shareData;
        } catch (e) {
            console.error("Error retrieving share data:", e);
            localStorage.removeItem('pyloom_share_' + id);
            return null;
        }
    },
    
    cleanup: function() {
        const prefix = 'pyloom_share_';
        const now = Date.now();
        
        for (let i = localStorage.length - 1; i >= 0; i--) {
            const key = localStorage.key(i);
            if (key && key.startsWith(prefix)) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (!data.expiration || now > data.expiration) {
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    console.error("Error cleaning up share data:", e);
                    localStorage.removeItem(key);
                }
            }
        }
    }
};

        // Python Compiler Implementation
        class PythonCompiler {
            constructor() {
                this.errors = [];
                this.warnings = [];
                this.ast = null;
                this.bytecode = [];
            }
            
            // Lexical analysis - tokenize the code
            tokenize(code) {
                const tokens = [];
                const lines = code.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || line.startsWith('#')) continue;
                    
                    // Simple tokenization (in a real compiler, this would be more complex)
                    const lineTokens = line.split(/(\s+|\(|\)|\[|\]|\{|\}|,|:|\.|=|==|!=|<|>|<=|>=|\+|-|\*|\/|%|#)/)
                        .filter(token => token.trim() !== '');
                    
                    tokens.push({
                        line: i + 1,
                        tokens: lineTokens
                    });
                }
                
                return tokens;
            }
            
            // Syntax analysis - build AST
            parse(tokens) {
                const ast = {
                    type: 'Program',
                    body: []
                };
                
                for (const line of tokens) {
                    const node = this.parseLine(line.tokens, line.line);
                    if (node) {
                        ast.body.push(node);
                    }
                }
                
                this.ast = ast;
                return ast;
            }
            
            parseLine(tokens, lineNumber) {
                if (tokens.length === 0) return null;
                
                // Check for function definition
                if (tokens[0] === 'def') {
                    return this.parseFunctionDef(tokens, lineNumber);
                }
                
                // Check for if statement
                if (tokens[0] === 'if') {
                    return this.parseIfStatement(tokens, lineNumber);
                }
                
                // Check for variable assignment
                if (tokens.length >= 3 && tokens[1] === '=') {
                    return this.parseAssignment(tokens, lineNumber);
                }
                
                // Default to expression
                return this.parseExpression(tokens, lineNumber);
            }
            
            parseFunctionDef(tokens, lineNumber) {
                if (tokens.length < 4 || tokens[0] !== 'def') {
                    this.errors.push(`Syntax error at line ${lineNumber}: Invalid function definition`);
                    return null;
                }
                
                return {
                    type: 'FunctionDef',
                    name: tokens[1],
                    parameters: tokens[3] === ':' ? [] : tokens.slice(3, tokens.indexOf(':')),
                    body: [],
                    line: lineNumber
                };
            }
            
            parseIfStatement(tokens, lineNumber) {
                return {
                    type: 'IfStatement',
                    condition: tokens.slice(1, tokens.indexOf(':')),
                    body: [],
                    line: lineNumber
                };
            }
            
            parseAssignment(tokens, lineNumber) {
                return {
                    type: 'Assignment',
                    target: tokens[0],
                    value: tokens.slice(2).join(' '),
                    line: lineNumber
                };
            }
            
            parseExpression(tokens, lineNumber) {
                return {
                    type: 'Expression',
                    value: tokens.join(' '),
                    line: lineNumber
                };
            }
            
            // Generate bytecode
            generateBytecode(ast) {
                const bytecode = [];
                
                for (const node of ast.body) {
                    switch (node.type) {
                        case 'FunctionDef':
                            bytecode.push(`LOAD_CONST <function ${node.name}>`);
                            bytecode.push(`STORE_NAME ${node.name}`);
                            break;
                        case 'Assignment':
                            bytecode.push(`LOAD_CONST ${node.value}`);
                            bytecode.push(`STORE_NAME ${node.target}`);
                            break;
                        case 'Expression':
                            bytecode.push(`LOAD_NAME ${node.value}`);
                            bytecode.push(`PRINT_ITEM`);
                            break;
                        case 'IfStatement':
                            bytecode.push(`LOAD_CONST ${node.condition.join(' ')}`);
                            bytecode.push(`POP_JUMP_IF_FALSE <end_if>`);
                            break;
                    }
                }
                
                this.bytecode = bytecode;
                return bytecode;
            }
            
            // Compile Python code
            compile(code) {
                this.errors = [];
                this.warnings = [];
                
                // Tokenize
                const tokens = this.tokenize(code);
                
                // Parse
                const ast = this.parse(tokens);
                
                // Generate bytecode
                const bytecode = this.generateBytecode(ast);
                
                return {
                    success: this.errors.length === 0,
                    errors: this.errors,
                    warnings: this.warnings,
                    ast: ast,
                    bytecode: bytecode,
                    tokens: tokens
                };
            }
            
            // Format AST for display
            formatAST(ast, indent = 0) {
                if (!ast) return '';
                
                let result = '';
                const spaces = '  '.repeat(indent);
                
                if (ast.type === 'Program') {
                    result += `${spaces}Program\n`;
                    for (const node of ast.body) {
                        result += this.formatAST(node, indent + 1);
                    }
                } else if (ast.type === 'FunctionDef') {
                    result += `${spaces}FunctionDef: ${ast.name}\n`;
                    result += `${spaces}  Parameters: ${ast.parameters.join(', ')}\n`;
                    result += `${spaces}  Body:\n`;
                    for (const node of ast.body) {
                        result += this.formatAST(node, indent + 2);
                    }
                } else if (ast.type === 'Assignment') {
                    result += `${spaces}Assignment: ${ast.target} = ${ast.value}\n`;
                } else if (ast.type === 'Expression') {
                    result += `${spaces}Expression: ${ast.value}\n`;
                } else if (ast.type === 'IfStatement') {
                    result += `${spaces}IfStatement: if ${ast.condition.join(' ')}\n`;
                    result += `${spaces}  Body:\n`;
                    for (const node of ast.body) {
                        result += this.formatAST(node, indent + 2);
                    }
                }
                
                return result;
            }
        }

        // Run cleanup on load
        shareDB.cleanup();

        const themes = {
            dracula: {
                bodyBg: "#1e1e2f",
                text: "#e0e0e0",
                controlBg: "#282a36",
                buttonBg: "#6272a4",
                buttonHover: "#50fa7b",
                outputBg: "#282a36",
                popupSuccess: "#50fa7b",
                popupError: "#ff5555",
                popupWarning: "#ffb86c",
                popupInfo: "#8be9fd",
                footerBorder: "#44475a",
                font: "'Fira Code', monospace",
                cmTheme: "dracula"
            },
            eclipse: {
                bodyBg: "#ffffff",
                text: "#000000",
                controlBg: "#e0e0e0",
                buttonBg: "#d1d1d1",
                buttonHover: "#8ab4f8",
                outputBg: "#f7f7f7",
                popupSuccess: "#a0d468",
                popupError: "#ed5565",
                popupWarning: "#f6bb42",
                popupInfo: "#4fc1e9",
                footerBorder: "#ccc",
                font: "'Source Code Pro', monospace",
                cmTheme: "eclipse"
            },
            monokai: {
                bodyBg: "#272822",
                text: "#f8f8f2",
                controlBg: "#3e3d32",
                buttonBg: "#75715e",
                buttonHover: "#f92672",
                outputBg: "#3e3d32",
                popupSuccess: "#a6e22e",
                popupError: "#f92672",
                popupWarning: "#fd971f",
                popupInfo: "#66d9ef",
                footerBorder: "#555",
                font: "'JetBrains Mono', monospace",
                cmTheme: "monokai"
            },
            solarized: {
                bodyBg: "#fdf6e3",
                text: "#657b83",
                controlBg: "#eee8d5",
                buttonBg: "#93a1a1",
                buttonHover: "#2aa198",
                outputBg: "#eee8d5",
                popupSuccess: "#859900",
                popupError: "#dc322f",
                popupWarning: "#b58900",
                popupInfo: "#268bd2",
                footerBorder: "#93a1a1",
                font: "'Ubuntu Mono', monospace",
                cmTheme: "solarized"
            },
            ambiance: {
                bodyBg: "#2e2e2e",
                text: "#f8f8f2",
                controlBg: "#3e3d32",
                buttonBg: "#75715e",
                buttonHover: "#f92672",
                outputBg: "#3e3d32",
                popupSuccess: "#a6e22e",
                popupError: "#f92672",
                popupWarning: "#fd971f",
                popupInfo: "#66d9ef",
                footerBorder: "#555",
                font: "'Inconsolata', monospace",
                cmTheme: "ambiance"
            },
            blackboard: {
                bodyBg: "#2e2e2e",
                text: "#f8f8f2",
                controlBg: "#3e3d32",
                buttonBg: "#75715e",
                buttonHover: "#f92672",
                outputBg: "#3e3d32",
                popupSuccess: "#a6e22e",
                popupError: "#f92672",
                popupWarning: "#fd971f",
                popupInfo: "#66d9ef",
                footerBorder: "#555",
                font: "'Inconsolata', monospace",
                cmTheme: "blackboard"
            },
            "base16-dark": {
                bodyBg: "#181818",
                text: "#d0d0d0",
                controlBg: "#282828",
                buttonBg: "#505050",
                buttonHover: "#f0c674",
                outputBg: "#282828",
                popupSuccess: "#b5bd68",
                popupError: "#cc6666",
                popupWarning: "#de935f",
                popupInfo: "#81a2be",
                footerBorder: "#444",
                font: "'JetBrains Mono', monospace",
                cmTheme: "base16-dark"
            },
            "base16-light": {
                bodyBg: "#f5f5f5",
                text: "#333333",
                controlBg: "#e5e5e5",
                buttonBg: "#d5d5d5",
                buttonHover: "#81a2be",
                outputBg: "#e5e5e5",
                popupSuccess: "#8c9440",
                popupError: "#cc6666",
                popupWarning: "#b294bb",
                popupInfo: "#4271ae",
                footerBorder: "#aaa",
                font: "'Source Code Pro', monospace",
                cmTheme: "base16-light"
            },
            material: {
                bodyBg: "#263238",
                text: "#eceff1",
                controlBg: "#37474f",
                buttonBg: "#546e7a",
                buttonHover: "#ffca28",
                outputBg: "#37474f",
                popupSuccess: "#4caf50",
                popupError: "#f44336",
                popupWarning: "#ff9800",
                popupInfo: "#2196f3",
                footerBorder: "#546e7a",
                font: "'JetBrains Mono', monospace",
                cmTheme: "material"
            },
            "mdn-like": {
                bodyBg: "#ffffff",
                text: "#000000",
                controlBg: "#f0f0f0",
                buttonBg: "#d0d0d0",
                buttonHover: "#6c63ff",
                outputBg: "#f7f7f7",
                popupSuccess: "#00c853",
                popupError: "#d50000",
                popupWarning: "#ffab00",
                popupInfo: "#2962ff",
                footerBorder: "#ccc",
                font: "'Fira Code', monospace",
                cmTheme: "mdn-like"
            },
            hacker: {
                bodyBg: "#000000",
                text: "#00ff00",
                controlBg: "#001100",
                buttonBg: "#003300",
                buttonHover: "#00ff66",
                outputBg: "#000000",
                popupSuccess: "#00ff00",
                popupError: "#ff0033",
                popupWarning: "#ffff00",
                popupInfo: "#00ffff",
                footerBorder: "#004400",
                font: "'Share Tech Mono', monospace",
                cmTheme: "dracula"
            },
            matrix: {
                bodyBg: "#000000",
                text: "#00ff41",
                controlBg: "#001a00",
                buttonBg: "#003300",
                buttonHover: "#00ff88",
                outputBg: "#000000",
                popupSuccess: "#00ff41",
                popupError: "#ff0055",
                popupWarning: "#ffff00",
                popupInfo: "#00ffff",
                footerBorder: "#004d00",
                font: "'VT323', monospace",
                cmTheme: "dracula"
            },
            nord: {
                bodyBg: "#2e3440",
                text: "#d8dee9",
                controlBg: "#3b4252",
                buttonBg: "#434c5e",
                buttonHover: "#88c0d0",
                outputBg: "#3b4252",
                popupSuccess: "#a3be8c",
                popupError: "#bf616a",
                popupWarning: "#ebcb8b",
                popupInfo: "#81a1c1",
                footerBorder: "#4c566a",
                font: "'Overpass Mono', monospace",
                cmTheme: "material"
            },
            cyberpunk: {
                bodyBg: "#0d0221",
                text: "#ff00ff",
                controlBg: "#1a0033",
                buttonBg: "#330066",
                buttonHover: "#00e5ff",
                outputBg: "#1a0033",
                popupSuccess: "#00e5ff",
                popupError: "#ff004d",
                popupWarning: "#ff9d00",
                popupInfo: "#39ff14",
                footerBorder: "#660099",
                font: "'Press Start 2P', monospace",
                cmTheme: "dracula"
            },
            vintage: {
                bodyBg: "#f4ecd8",
                text: "#3b2f2f",
                controlBg: "#e0d4b7",
                buttonBg: "#c9b79c",
                buttonHover: "#8b5e3c",
                outputBg: "#e0d4b7",
                popupSuccess: "#6b8e23",
                popupError: "#8b0000",
                popupWarning: "#daa520",
                popupInfo: "#4169e1",
                footerBorder: "#a58d6f",
                font: "'Courier Prime', monospace",
                cmTheme: "eclipse"
            },
            midnight: {
                bodyBg: "#0b0c10",
                text: "#c5c6c7",
                controlBg: "#1f2833",
                buttonBg: "#2a3f54",
                buttonHover: "#66fcf1",
                outputBg: "#1f2833",
                popupSuccess: "#45a29e",
                popupError: "#ff4c4c",
                popupWarning: "#ffb347",
                popupInfo: "#5d8aa8",
                footerBorder: "#45a29e",
                font: "'Space Mono', monospace",
                cmTheme: "material"
            },
            nebula: {
                bodyBg: "#0b1220",
                text: "#dbe9ff",
                controlBg: "#0f2340",
                buttonBg: "#1b3a70",
                buttonHover: "#7ec8ff",
                outputBg: "#081122",
                popupSuccess: "#7ec8ff",
                popupError: "#ff6b6b",
                popupWarning: "#ffd93d",
                popupInfo: "#6bebff",
                footerBorder: "#12304f",
                font: "'Roboto Mono', monospace",
                cmTheme: "material"
            },
            ether: {
                bodyBg: "#f6f8fb",
                text: "#141625",
                controlBg: "#eef3fb",
                buttonBg: "#d6e6ff",
                buttonHover: "#4a6cf7",
                outputBg: "#f0f5fb",
                popupSuccess: "#4a8f5b",
                popupError: "#d64545",
                popupWarning: "#e6a23c",
                popupInfo: "#409eff",
                footerBorder: "#cfe1ff",
                font: "'Anonymous Pro', monospace",
                cmTheme: "mdn-like"
            },
            polaris: {
                bodyBg: "#071E26",
                text: "#CFECEB",
                controlBg: "#0b2a34",
                buttonBg: "#174650",
                buttonHover: "#6fe3d8",
                outputBg: "#071E26",
                popupSuccess: "#6fe3d8",
                popupError: "#ff6b6b",
                popupWarning: "#ffd93d",
                popupInfo: "#4dccbd",
                footerBorder: "#0f484f",
                font: "'PT Mono', monospace",
                cmTheme: "dracula"
            },
            byte: {
                bodyBg: "#0f1115",
                text: "#e6f7ff",
                controlBg: "#1b1f27",
                buttonBg: "#263249",
                buttonHover: "#9ad3ff",
                outputBg: "#0f1115",
                popupSuccess: "#9ad3ff",
                popupError: "#ff7a7a",
                popupWarning: "#ffcc5c",
                popupInfo: "#88d8b0",
                footerBorder: "#243544",
                font: "'M PLUS 1 Code', monospace",
                cmTheme: "base16-dark"
            },
            classic: {
                bodyBg: "#ffffff",
                text: "#222222",
                controlBg: "#fbfbfb",
                buttonBg: "#e9e9e9",
                buttonHover: "#666666",
                outputBg: "#ffffff",
                popupSuccess: "#2e7d32",
                popupError: "#c62828",
                popupWarning: "#f9a825",
                popupInfo: "#1565c0",
                footerBorder: "#ddd",
                font: "'Major Mono Display', monospace",
                cmTheme: "eclipse"
            },
            carbon: {
                bodyBg: "#0f1113",
                text: "#e6eef6",
                controlBg: "#151617",
                buttonBg: "#1f2326",
                buttonHover: "#61dafb",
                outputBg: "#0f1113",
                popupSuccess: "#21ba45",
                popupError: "#ff6b6b",
                popupWarning: "#f2c94c",
                popupInfo: "#2d9cdb",
                footerBorder: "#222222",
                font: "'IBM Plex Mono', monospace",
                cmTheme: "base16-dark"
            },
            paper: {
                bodyBg: "#ffffff",
                text: "#222222",
                controlBg: "#fafafa",
                buttonBg: "#f0f0f0",
                buttonHover: "#4285f4",
                outputBg: "#ffffff",
                popupSuccess: "#34a853",
                popupError: "#ea4335",
                popupWarning: "#fbbc04",
                popupInfo: "#4285f4",
                footerBorder: "#e0e0e0",
                font: "'Roboto Mono', monospace",
                cmTheme: "base16-light"
            },
            zenburn: {
                bodyBg: "#3f3f3f",
                text: "#dcdccc",
                controlBg: "#4f4f4f",
                buttonBg: "#6f6f6f",
                buttonHover: "#8faf9f",
                outputBg: "#4f4f4f",
                popupSuccess: "#7f9f7f",
                popupError: "#cc9393",
                popupWarning: "#e0cf9f",
                popupInfo: "#8cd0d3",
                footerBorder: "#5f5f5f",
                font: "'Anonymous Pro', monospace",
                cmTheme: "ambiance"
            },
            gruvbox: {
                bodyBg: "#282828",
                text: "#ebdbb2",
                controlBg: "#3c3836",
                buttonBg: "#504945",
                buttonHover: "#fabd2f",
                outputBg: "#3c3836",
                popupSuccess: "#b8bb26",
                popupError: "#fb4934",
                popupWarning: "#fabd2f",
                popupInfo: "#83a598",
                footerBorder: "#665c54",
                font: "'Cousine', monospace",
                cmTheme: "monokai"
            },
            "tokyo-night": {
                bodyBg: "#1a1b26",
                text: "#c0caf5",
                controlBg: "#24283b",
                buttonBg: "#292e42",
                buttonHover: "#7aa2f7",
                outputBg: "#24283b",
                popupSuccess: "#9ece6a",
                popupError: "#f7768e",
                popupWarning: "#e0af68",
                popupInfo: "#7dcfff",
                footerBorder: "#414868",
                font: "'Nova Mono', monospace",
                cmTheme: "material"
            },
        };

        // Initialize CodeMirror with enhanced features
        const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
            lineNumbers: true,
            mode: "python",
            theme: "dracula",
            indentUnit: 4,
            tabSize: 4,
            autoCloseBrackets: true,
            matchBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            extraKeys: {
                "Ctrl-S": function(cm) { saveFile(); },
                "Ctrl-F": function(cm) { openFindReplace(); },
                "Ctrl-/": function(cm) { toggleComment(); },
                "Ctrl-D": function(cm) { 
                    const cursor = cm.getCursor();
                    const word = cm.findWordAt(cursor);
                    cm.setSelections([{
                        anchor: word.anchor,
                        head: word.head
                    }]);
                },
                "Tab": function(cm) {
                    if (cm.somethingSelected()) {
                        cm.indentSelection("add");
                    } else {
                        cm.replaceSelection("    ", "end");
                    }
                },
                "Shift-Tab": function(cm) {
                    cm.indentSelection("subtract");
                }
            }
        });

        // Global variables
        let inputResolver = null;
        let isWaitingForInput = false;
        let currentExecution = null;
        let executionStartTime = 0;
        let isDebugMode = false;
        let debugStep = 0;
        let debugCodeLines = [];
        let executionMode = 'interpreter'; // 'interpreter' or 'compiler'
        let compiler = new PythonCompiler();
        let runAttempts = 0, clearAttempts = 0;

        // Add this function to properly load the saved theme
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem("pyloom-editor-theme");
            if (savedTheme && themes[savedTheme]) {
                // Apply the theme to both CodeMirror and the UI
                const cmTheme = themes[savedTheme].cmTheme || savedTheme;
                editor.setOption("theme", cmTheme);
                applyTheme(savedTheme);
                document.getElementById("themeSelect").value = savedTheme;
                console.log("Loaded saved theme:", savedTheme);
                return true;
            }
            return false;
        }

        // Update the window.load event listener to properly load the theme
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            
            // Set up input handling
            document.getElementById('submit-input').addEventListener('click', handleUserInput);
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleUserInput();
                }
            });
            
            // Update cursor position
            editor.on('cursorActivity', updateCursorPosition);
            
            // Load settings
            loadSettings();
            
            // Set current year
            document.getElementById("year").textContent = new Date().getFullYear();
            
            // Update mode indicator
            updateModeIndicator();
            
            // Load saved code
            const savedCode = localStorage.getItem("pyloom-editor-code");
            if (savedCode !== null) editor.setValue(savedCode);
            
            editor.on("change", () => {
                localStorage.setItem("pyloom-editor-code", editor.getValue());
            });

            // Handle theme loading - do this LAST after everything else is set up
            if (shareId) {
                loadSharedCode(shareId);
            } else {
                // Only load saved theme if not loading shared code
                if (!loadSavedTheme()) {
                    // Fallback to default theme
                    const defaultTheme = "dracula";
                    console.log("Using default theme:", defaultTheme);
                    editor.setOption("theme", themes[defaultTheme].cmTheme || defaultTheme);
                    applyTheme(defaultTheme);
                    document.getElementById("themeSelect").value = defaultTheme;
                }
            }
        });

        // Enhanced output tab system
        function switchOutputTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.output-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.output-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate selected tab and panel
            document.getElementById(`${tabName}-panel`).classList.add('active');
            document.querySelector(`.output-tab[onclick="switchOutputTab('${tabName}')"]`).classList.add('active');
        }

        // Execution mode management
        function changeExecutionMode(mode) {
            executionMode = mode;
            localStorage.setItem('pyloom-execution-mode', mode);
            updateModeIndicator();
            showPopup(`Execution mode changed to ${mode.toUpperCase()}`, "success", 3);
        }

        function updateModeIndicator() {
            const indicator = document.getElementById('mode-indicator');
            indicator.textContent = executionMode.toUpperCase();
            indicator.className = `mode-indicator mode-${executionMode}`;
        }

        // Compiler functionality
        function compileCode() {
            const code = editor.getValue();
            document.getElementById("compiler-output").innerHTML = "";
            document.getElementById("ast-visualization").innerHTML = "";
            document.getElementById("bytecode-output").innerHTML = "";
            
            executionStartTime = Date.now();
            document.getElementById("execution-status").textContent = "Compiling...";
            document.getElementById("execution-status").style.color = "var(--info-color)";
            
            // Use setTimeout to allow UI to update
            setTimeout(() => {
                const result = compiler.compile(code);
                
                // Display compiler results
                let compilerOutput = "";
                
                if (result.errors.length > 0) {
                    compilerOutput += "<h3>Compilation Errors:</h3>";
                    result.errors.forEach(error => {
                        compilerOutput += `<div class="compiler-line compiler-error">${error}</div>`;
                    });
                } else {
                    compilerOutput += "<div class='compiler-line compiler-info'>Compilation successful!</div>";
                }
                
                if (result.warnings.length > 0) {
                    compilerOutput += "<h3>Warnings:</h3>";
                    result.warnings.forEach(warning => {
                        compilerOutput += `<div class="compiler-line compiler-warning">${warning}</div>`;
                    });
                }
                
                compilerOutput += `<div class="compiler-line compiler-info">Tokens found: ${result.tokens.length} lines</div>`;
                
                document.getElementById("compiler-output").innerHTML = compilerOutput;
                
                // Display AST
                if (result.ast) {
                    const astOutput = compiler.formatAST(result.ast);
                    document.getElementById("ast-visualization").innerHTML = `<pre>${astOutput}</pre>`;
                }
                
                // Display bytecode
                if (result.bytecode.length > 0) {
                    let bytecodeOutput = "<h3>Generated Bytecode:</h3>";
                    result.bytecode.forEach((instruction, index) => {
                        bytecodeOutput += `<div class="bytecode-line"><span class="bytecode-op">${index.toString().padStart(3, '0')}:</span> ${instruction}</div>`;
                    });
                    document.getElementById("bytecode-output").innerHTML = bytecodeOutput;
                }
                
                const compilationTime = (Date.now() - executionStartTime) / 1000;
                document.getElementById("execution-time").textContent = compilationTime.toFixed(2) + "s";
                document.getElementById("execution-status").textContent = result.errors.length > 0 ? "Compilation Failed" : "Compilation Complete";
                document.getElementById("execution-status").style.color = result.errors.length > 0 ? "var(--error-color)" : "var(--success-color)";
                
                // Switch to compiler tab
                switchOutputTab('compiler');
                
                showPopup(`Code compiled with ${result.errors.length} errors, ${result.warnings.length} warnings`, 
                         result.errors.length > 0 ? "error" : "success", 5);
            }, 100);
        }

        // Enhanced runCode function with mode support
        function runCode() {
            if (executionMode === 'compiler') {
                compileCode();
                return;
            }
            
            // Original interpreter code
            if (currentExecution) {
                try {
                    currentExecution.cancel();
                } catch (e) {
                    // Ignore cancellation errors
                }
            }
            
            document.getElementById("output-content").innerHTML = "";
            document.getElementById("input-container").style.display = "none";
            
            document.getElementById("execution-status").textContent = "Running...";
            document.getElementById("execution-status").style.color = "var(--success-color)";
            executionStartTime = Date.now();
            
            Sk.configure({ 
                output: outf, 
                read: builtinRead,
                inputfun: customInput,
                inputfunTakesPrompt: true,
                __future__: Sk.python3
            });
            
            const code = editor.getValue();
            let hadError = false;
            
            currentExecution = Sk.misceval.asyncToPromise(() => {
                return Sk.importMainWithBody("<stdin>", false, code, true);
            });
            
            currentExecution
                .then(() => {
                    runAttempts++;
                    const executionTime = (Date.now() - executionStartTime) / 1000;
                    document.getElementById("execution-time").textContent = executionTime.toFixed(2) + "s";
                    document.getElementById("execution-status").textContent = "Finished";
                    document.getElementById("execution-status").style.color = "var(--success-color)";
                    
                    if (!hadError) showPopup(`Code executed (attempt #${runAttempts})`, "success", 3);
                    currentExecution = null;
                    isDebugMode = false;
                })
                .catch(err => {
                    hadError = true;
                    runAttempts++;
                    const executionTime = (Date.now() - executionStartTime) / 1000;
                    document.getElementById("execution-time").textContent = executionTime.toFixed(2) + "s";
                    
                    if (err.toString().includes("SuspensionError")) {
                        document.getElementById("execution-status").textContent = "Waiting for input...";
                        document.getElementById("execution-status").style.color = "var(--warning-color)";
                        return;
                    }
                    
                    document.getElementById("output-content").innerHTML += `<span style="color:var(--error-color);">${err}</span>`;
                    document.getElementById("execution-status").textContent = "Error";
                    document.getElementById("execution-status").style.color = "var(--error-color)";
                    showPopup(`Execution error (attempt #${runAttempts})`, "error", 4);
                    currentExecution = null;
                    isDebugMode = false;
                });
                
            // Switch to output tab
            switchOutputTab('output');
        }

        // Settings functionality
        function openSettingsPopup() {
            const overlay = document.getElementById("settings-popup-overlay");
            overlay.classList.add("show");
            const popup = document.getElementById("settings-popup");
            popup.style.animation = 'popupOpen 0.3s forwards';
        }

        function closeSettingsPopup() {
            const popup = document.getElementById("settings-popup");
            popup.style.animation = 'popupClose 0.3s forwards';
            setTimeout(() => document.getElementById("settings-popup-overlay").classList.remove("show"), 300);
        }

        function loadSettings() {
            const fontSize = localStorage.getItem("pyloom-font-size") || "14";
            const tabSize = localStorage.getItem("pyloom-tab-size") || "4";
            const lineNumbers = localStorage.getItem("pyloom-line-numbers") !== "false";
            const autoCloseBrackets = localStorage.getItem("pyloom-auto-close-brackets") !== "false";
            const matchBrackets = localStorage.getItem("pyloom-match-brackets") !== "false";
            const autoIndent = localStorage.getItem("pyloom-auto-indent") !== "false";
            const codeFolding = localStorage.getItem("pyloom-code-folding") !== "false";
            const autoSave = localStorage.getItem("pyloom-auto-save") !== "false";
            const execMode = localStorage.getItem("pyloom-execution-mode") || "interpreter";
            
            document.getElementById("font-size").value = fontSize;
            document.getElementById("font-size-value").textContent = fontSize + "px";
            document.getElementById("tab-size").value = tabSize;
            document.getElementById("line-numbers").checked = lineNumbers;
            document.getElementById("auto-close-brackets").checked = autoCloseBrackets;
            document.getElementById("match-brackets").checked = matchBrackets;
            document.getElementById("auto-indent").checked = autoIndent;
            document.getElementById("code-folding").checked = codeFolding;
            document.getElementById("auto-save").checked = autoSave;
            document.getElementById("execution-mode").value = execMode;
            
            executionMode = execMode;
            updateModeIndicator();
            
            updateFontSize(fontSize);
            updateTabSize(tabSize);
            toggleLineNumbers(lineNumbers);
            toggleAutoCloseBrackets(autoCloseBrackets);
            toggleMatchBrackets(matchBrackets);
            toggleAutoIndent(autoIndent);
            toggleCodeFolding(codeFolding);
            toggleAutoSave(autoSave);
        }

        function updateFontSize(size) {
            editor.getWrapperElement().style.fontSize = size + "px";
            editor.refresh();
            document.getElementById("font-size-value").textContent = size + "px";
            localStorage.setItem("pyloom-font-size", size);
        }

        function updateTabSize(size) {
            editor.setOption("tabSize", parseInt(size));
            editor.setOption("indentUnit", parseInt(size));
            localStorage.setItem("pyloom-tab-size", size);
        }

        function toggleLineNumbers(show) {
            editor.setOption("lineNumbers", show);
            localStorage.setItem("pyloom-line-numbers", show);
        }

        function toggleAutoCloseBrackets(enable) {
            editor.setOption("autoCloseBrackets", enable);
            localStorage.setItem("pyloom-auto-close-brackets", enable);
        }

        function toggleMatchBrackets(enable) {
            editor.setOption("matchBrackets", enable);
            localStorage.setItem("pyloom-match-brackets", enable);
        }

        function toggleAutoIndent(enable) {
            editor.setOption("electricChars", enable);
            localStorage.setItem("pyloom-auto-indent", enable);
        }

        function toggleCodeFolding(enable) {
            editor.setOption("foldGutter", enable);
            localStorage.setItem("pyloom-code-folding", enable);
        }

        function toggleAutoSave(enable) {
            if (enable) {
                editor.on("change", autoSaveCode);
            } else {
                editor.off("change", autoSaveCode);
            }
            localStorage.setItem("pyloom-auto-save", enable);
        }

        function autoSaveCode() {
            localStorage.setItem("pyloom-editor-code", editor.getValue());
        }

        // Find and Replace functionality
        function openFindReplace() {
            const findPopup = document.getElementById("find-replace-popup");
            findPopup.style.display = "block";
            document.getElementById("find-input").focus();
        }

        function closeFindReplace() {
            document.getElementById("find-replace-popup").style.display = "none";
            editor.execCommand("clearMatches");
        }

        function findNext() {
            const findText = document.getElementById("find-input").value;
            if (!findText) return;
            
            editor.execCommand("clearMatches");
            editor.execCommand("find", findText);
        }

        function replaceNext() {
            const findText = document.getElementById("find-input").value;
            const replaceText = document.getElementById("replace-input").value;
            
            if (!findText) return;
            
            const cursor = editor.getSearchCursor(findText, editor.getCursor());
            if (cursor.findNext()) {
                cursor.replace(replaceText);
            }
        }

        function replaceAll() {
            const findText = document.getElementById("find-input").value;
            const replaceText = document.getElementById("replace-input").value;
            
            if (!findText) return;
            
            editor.setValue(editor.getValue().replace(new RegExp(findText, "g"), replaceText));
        }

        // Code formatting and manipulation
        function toggleComment() {
            editor.toggleComment();
        }

        function formatCode() {
            // Simple Python code formatter - indentation only
            const code = editor.getValue();
            const lines = code.split('\n');
            let indentLevel = 0;
            let formattedLines = [];
            
            for (let line of lines) {
                const trimmedLine = line.trim();
                
                // Decrease indent after dedent keywords
                if (trimmedLine.startsWith('return') || trimmedLine.startsWith('break') || 
                    trimmedLine.startsWith('continue') || trimmedLine.startsWith('pass')) {
                    // Keep at current level
                } else if (trimmedLine.startsWith('elif') || trimmedLine.startsWith('else') || 
                           trimmedLine.startsWith('except') || trimmedLine.startsWith('finally')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                
                // Add line with proper indentation
                formattedLines.push('    '.repeat(indentLevel) + trimmedLine);
                
                // Increase indent after indent keywords
                if (trimmedLine.endsWith(':') && !trimmedLine.startsWith('#')) {
                    indentLevel++;
                }
            }
            
            editor.setValue(formattedLines.join('\n'));
            showPopup("Code formatted!", "success", 2);
        }

        function changeFontSize(delta) {
            const currentSize = parseInt(document.getElementById("font-size").value);
            const newSize = Math.max(12, Math.min(24, currentSize + delta));
            document.getElementById("font-size").value = newSize;
            updateFontSize(newSize);
        }

        function updateCursorPosition() {
            const cursor = editor.getCursor();
            document.getElementById("cursor-position").textContent = `Line ${cursor.line + 1}, Column ${cursor.ch + 1}`;
        }

        // Fullscreen functionality
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Output management
        function clearOutput() {
            document.getElementById("output-content").innerHTML = "";
            showPopup("Output cleared", "success", 2);
        }

        function copyOutput() {
            const outputText = document.getElementById("output-content").innerText;
            navigator.clipboard.writeText(outputText).then(() => {
                showPopup("Output copied to clipboard", "success", 2);
            });
        }

        // Debug functionality
        function debugCode() {
            isDebugMode = true;
            debugStep = 0;
            debugCodeLines = editor.getValue().split('\n');
            document.getElementById("output-content").innerHTML = "";
            document.getElementById("execution-status").textContent = "Debug Mode";
            document.getElementById("execution-status").style.color = "var(--warning-color)";
            showPopup("Debug mode activated. Use Run to step through code.", "success", 3);
        }

        // Custom input function for Skulpt
        function builtinRead(x) {
            if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined) {
                throw "File not found: '" + x + "'";
            }
            return Sk.builtinFiles["files"][x];
        }

        // Custom input function that shows prompt in output
        function customInput(prompt) {
            return new Promise((resolve) => {
                isWaitingForInput = true;
                inputResolver = resolve;
                
                // Show the input prompt in the output
                outf(prompt);
                
                // Show the input container
                const inputContainer = document.getElementById("input-container");
                const inputPrompt = document.getElementById("input-prompt");
                const userInput = document.getElementById("user-input");
                
                inputPrompt.textContent = prompt;
                inputContainer.style.display = "block";
                userInput.focus();
                
                // Scroll to bottom to show the input
                const outputContent = document.getElementById("output-content");
                outputContent.scrollTop = outputContent.scrollHeight;
            });
        }

        // Handle user input submission
        function handleUserInput() {
            if (!isWaitingForInput || !inputResolver) return;
            
            const userInput = document.getElementById("user-input");
            const inputValue = userInput.value;
            
            // Hide the input container
            document.getElementById("input-container").style.display = "none";
            
            // Clear the input field
            userInput.value = "";
            
            // Resolve the promise with the input value
            inputResolver(inputValue);
            inputResolver = null;
            isWaitingForInput = false;
        }

        function outf(text) {
            const outputContent = document.getElementById("output-content");
            outputContent.innerHTML += text + "<br>";
            outputContent.scrollTop = outputContent.scrollHeight;
        }

        function clearEditor() {
            // Stop any currently running execution
            if (currentExecution) {
                try {
                    currentExecution.cancel();
                } catch (e) {
                    // Ignore cancellation errors
                }
                currentExecution = null;
            }
            
            editor.setValue("");
            document.getElementById("output-content").innerHTML = "";
            document.getElementById("input-container").style.display = "none";
            document.getElementById("execution-status").textContent = "Ready";
            document.getElementById("execution-status").style.color = "";
            document.getElementById("execution-time").textContent = "0.00s";
            clearAttempts++;
            showPopup(`Code cleared (attempt #${clearAttempts})`, "success", 3);
            isDebugMode = false;
        }

        function saveFile() {
            let filename = document.getElementById("filename").value.trim();
            if (!filename) filename = "script.py";
            else if (!filename.endsWith(".py")) filename += ".py";
            
            const blob = new Blob([editor.getValue()], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            showPopup(`Code saved as '${filename}'!`, "success", 3);
        }

        function showPopup(message, type = "success", duration = 3) {
            const container = document.getElementById("popup-container");
            // Get the current theme from the selector instead of relying on variables
            const currentTheme = document.getElementById("themeSelect").value;
            const t = themes[currentTheme] || themes.dracula; // Fallback to dracula
            
            const popup = document.createElement("div");
            popup.classList.add("popup");
            
            // Set background color based on type
            popup.style.backgroundColor = type === "error" ? t.popupError : 
                                 type === "warning" ? t.popupWarning :
                                 type === "info" ? t.popupInfo :
                                 t.popupSuccess;
            
            popup.style.fontFamily = t.font;
            popup.style.color = '#ffffff'; // Ensure text is readable
            
            let countdown = duration;
            popup.textContent = `${message} (${countdown})`;
            container.appendChild(popup);
            
            // Use setTimeout to ensure DOM is updated before adding show class
            setTimeout(() => {
                popup.classList.add("show");
            }, 10);
            
            const interval = setInterval(() => {
                countdown--;
                popup.textContent = `${message} (${countdown})`;
                if (countdown <= 0) {
                    clearInterval(interval);
                    popup.classList.remove("show");
                    setTimeout(() => {
                        if (popup.parentNode) {
                            popup.parentNode.removeChild(popup);
                        }
                    }, 500);
                }
            }, 1000);
        }

        function uploadFile(event) {
            const file = event.target.files[0];
            event.target.value = "";
            if (!file) return;
            
            if (!file.name.endsWith(".py")) {
                showPopup("Not a .py file", "error", 3);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                editor.setValue(e.target.result);
                editor.refresh();
                showPopup(`Successful upload of [${file.name}]!`, "success", 3);
            }
            reader.readAsText(file);
        }

        function openInfoPopup() {
            const overlay = document.getElementById("info-popup-overlay");
            overlay.classList.add("show");
            const popup = document.getElementById("info-popup");
            popup.style.animation = 'popupOpen 0.3s forwards';
        }

        function closeInfoPopup() {
            const popup = document.getElementById("info-popup");
            popup.style.animation = 'popupClose 0.3s forwards';
            setTimeout(() => document.getElementById("info-popup-overlay").classList.remove("show"), 300);
        }

        // Share functionality
        function openSharePopup() {
            const overlay = document.getElementById("share-popup-overlay");
            overlay.classList.add("show");
            const popup = document.getElementById("share-popup");
            popup.style.animation = 'popupOpen 0.3s forwards';
            document.getElementById("share-link").value = "";
        }

        function closeSharePopup() {
            const popup = document.getElementById("share-popup");
            popup.style.animation = 'popupClose 0.3s forwards';
            setTimeout(() => document.getElementById("share-popup-overlay").classList.remove("show"), 300);
        }

        function generateShareLink() {
            const code = editor.getValue();
            const currentTheme = document.getElementById("themeSelect").value;
            
            if (!code.trim()) {
                showPopup("Cannot share empty code", "error", 3);
                return;
            }
            
            const shareId = shareDB.saveCode(code, currentTheme);
            const shareUrl = window.location.origin + window.location.pathname + '?share=' + shareId;
            
            document.getElementById("share-link").value = shareUrl;
            showPopup("Share link generated! It will expire in 24 hours.", "success", 5);
        }

        function copyShareLink() {
            const shareLink = document.getElementById("share-link");
            
            if (!shareLink.value) {
                showPopup("Generate a link first", "error", 3);
                return;
            }
            
            shareLink.select();
            shareLink.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                navigator.clipboard.writeText(shareLink.value).then(function() {
                    showPopup("Link copied to clipboard!", "success", 3);
                }, function() {
                    // Fallback for older browsers
                    document.execCommand("copy");
                    showPopup("Link copied to clipboard!", "success", 3);
                });
            } catch (err) {
                // Final fallback
                document.execCommand("copy");
                showPopup("Link copied to clipboard!", "success", 3);
            }
        }

        function loadSharedCode(shareId) {
            const shareData = shareDB.getCode(shareId);
            
            if (shareData) {
                editor.setValue(shareData.code);
                if (shareData.theme && themes[shareData.theme]) {
                    // Use consistent theme application
                    const theme = shareData.theme;
                    const cmTheme = themes[theme].cmTheme || theme;
                    editor.setOption("theme", cmTheme);
                    applyTheme(theme);
                    document.getElementById("themeSelect").value = theme;
                    localStorage.setItem("pyloom-editor-theme", theme);
                    console.log("Loaded shared theme:", theme);
                } else {
                    // If shared theme is invalid, load saved theme or default
                    if (!loadSavedTheme()) {
                        const defaultTheme = "dracula";
                        editor.setOption("theme", themes[defaultTheme].cmTheme || defaultTheme);
                        applyTheme(defaultTheme);
                        document.getElementById("themeSelect").value = defaultTheme;
                    }
                }
                showPopup("Shared code loaded successfully!", "success", 5);
            } else {
                showPopup("Share link has expired or is invalid", "error", 5);
                // Load default theme if shared code is invalid
                if (!loadSavedTheme()) {
                    const defaultTheme = "dracula";
                    editor.setOption("theme", themes[defaultTheme].cmTheme || defaultTheme);
                    applyTheme(defaultTheme);
                    document.getElementById("themeSelect").value = defaultTheme;
                }
            }
        }

        // Fix the changeTheme function
        function changeTheme(theme) {
            if (!themes[theme]) {
                console.error("Theme not found:", theme);
                return;
            }
            
            console.log("Changing theme to:", theme);
            
            // Save theme first
            localStorage.setItem("pyloom-editor-theme", theme);
            
            // Then apply it
            const cmTheme = themes[theme].cmTheme || theme;
            editor.setOption("theme", cmTheme);
            applyTheme(theme);
            
            // Update the selector - this must happen after theme is applied
            document.getElementById("themeSelect").value = theme;
            
            // Show popup - ensure current theme is available for popup styling
            showPopup(`Theme changed to ${formatThemeName(theme)}`, "success", 3);
        }

        // Update the applyTheme function to apply the font to ALL elements
        function applyTheme(theme) {
            const t = themes[theme];
            if (!t) {
                console.error("Theme configuration not found for:", theme);
                return;
            }
            
            console.log("Applying theme:", theme);
            
            // Apply font to the entire document body and all elements
            document.body.style.fontFamily = t.font;
            
            // Apply to all elements using a more comprehensive approach
            const allElements = document.querySelectorAll('*');
            allElements.forEach(element => {
                element.style.fontFamily = t.font;
            });
            
            // Apply to body and main containers
            document.body.style.backgroundColor = t.bodyBg;
            document.body.style.color = t.text;
            
            // Apply to controls area
            const controls = document.getElementById("controls");
            if (controls) {
                controls.style.backgroundColor = t.controlBg;
            }
            
            // Apply to output container and panels
            const outputContainer = document.getElementById("output-container");
            if (outputContainer) {
                outputContainer.style.backgroundColor = t.outputBg;
                outputContainer.style.color = t.text;
            }
            
            document.querySelectorAll('.output-panel').forEach(panel => {
                panel.style.backgroundColor = t.outputBg;
                panel.style.color = t.text;
            });
            
            // Apply to footer
            const footer = document.querySelector("footer");
            if (footer) {
                footer.style.borderTopColor = t.footerBorder;
                footer.style.color = t.text;
            }
            
            // Apply to buttons and controls
            const buttons = document.querySelectorAll("button, label.choose-file, select, input");
            buttons.forEach(b => {
                b.style.backgroundColor = t.buttonBg;
                b.style.color = t.text;
                b.style.fontFamily = t.font;
                b.style.border = 'none';
            });
            
            // Apply specific font to textareas and inputs
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.style.fontFamily = t.font;
            });
            
            // Apply to popups
            const popups = ['info-popup', 'share-popup', 'settings-popup'];
            popups.forEach(popupId => {
                const popup = document.getElementById(popupId);
                if (popup) {
                    popup.style.backgroundColor = t.controlBg;
                    popup.style.color = t.text;
                    popup.style.fontFamily = t.font;
                    
                    // Apply font to all children of popups
                    const popupChildren = popup.querySelectorAll('*');
                    popupChildren.forEach(child => {
                        child.style.fontFamily = t.font;
                    });
                }
            });
            
            // Apply to CodeMirror editor - special handling
            const editorWrapper = editor.getWrapperElement();
            if (editorWrapper) {
                editorWrapper.style.backgroundColor = t.outputBg;
                editorWrapper.style.color = t.text;
                
                // Apply font to all CodeMirror elements
                const cmElements = editorWrapper.querySelectorAll('*');
                cmElements.forEach(element => {
                    element.style.fontFamily = t.font;
                });
                
                // Refresh the editor to ensure styles are applied
                setTimeout(() => {
                    editor.refresh();
                }, 10);
            }
            
            // Apply to headers
            const headers = document.querySelectorAll('header, h1, h2, h3, h4, h5, h6');
            headers.forEach(header => {
                header.style.fontFamily = t.font;
            });
            
            // Apply to status bars
            const statusItems = document.querySelectorAll('.status-bar, .status-item');
            statusItems.forEach(status => {
                status.style.fontFamily = t.font;
            });
            
            // Apply to tabs
            const tabs = document.querySelectorAll('.output-tab');
            tabs.forEach(tab => {
                tab.style.fontFamily = t.font;
            });
            
            // Apply to editor actions
            const editorActions = document.querySelectorAll('.editor-action');
            editorActions.forEach(action => {
                action.style.fontFamily = t.font;
            });
            
            // Update CSS variables for consistency
            document.documentElement.style.setProperty('--primary-color', t.buttonBg || '#6272a4');
            
            // Add a global style to ensure all new elements get the theme font
            let style = document.getElementById('theme-font-style');
            if (!style) {
                style = document.createElement('style');
                style.id = 'theme-font-style';
                document.head.appendChild(style);
            }
            style.textContent = `
                * {
                    font-family: ${t.font} !important;
                }
                
                /* Ensure CodeMirror specific elements get the font */
                .CodeMirror, .CodeMirror-code, .CodeMirror-linenumber, .CodeMirror-gutters,
                .CodeMirror-scroll, .CodeMirror-sizer, .CodeMirror-line {
                    font-family: ${t.font} !important;
                }
                
                /* Ensure all text elements get the font */
                body, div, span, p, pre, code, textarea, input, select, button, label,
                header, footer, h1, h2, h3, h4, h5, h6, a, li, ul, ol, td, th, table {
                    font-family: ${t.font} !important;
                }
            `;
        }

        // Also update the themes object to ensure all themes have proper font definitions
        // Add this to ensure any missing fonts fall back to Fira Code
        Object.keys(themes).forEach(themeName => {
            if (!themes[themeName].font) {
                themes[themeName].font = "'Fira Code', monospace";
            }
        });

        function formatThemeName(themeKey) {
            return themeKey.split("-").map(word => {
                if (word.length <= 3) return word.toUpperCase();
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(" ");
        }
    </script>
</body>
</html>
